<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <title>Pagamento riuscito</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      body { background:#0f172a; color:#fff; font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; min-height:100vh; display:flex; align-items:center; justify-content:center; }
      .box { background:#0b1120; padding:2rem 2.5rem; border-radius:1rem; text-align:center; max-width:520px; width:90vw; }
      .ok { color:#22c55e; margin-top:.75rem; }
      .err { color:#f43f5e; margin-top:.75rem; }
      .btn { margin-top:1.5rem; background:#4f46e5; border:none; padding:.6rem 1.4rem; border-radius:.75rem; color:#fff; cursor:pointer; font-weight:600; }
    </style>
  </head>
  <body>
    <div class="box">
      <h1>Pagamento riuscito</h1>
      <p id="status">Registro il tuo acquistoâ€¦</p>
      <button class="btn" onclick="location.href='/'">Torna al catalogo</button>
    </div>

    <script>
      const params = new URLSearchParams(location.search);
      const sessionId = params.get('session_id');

      async function run() {
        if (!sessionId) {
          document.getElementById('status').textContent = 'Sessione non trovata.';
          document.getElementById('status').className = 'err';
          return;
        }

        // 1) accredito minuti
        try {
          await fetch('/.netlify/functions/fulfillment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sessionId })
          });
        } catch (e) {
          console.warn('fulfillment error', e);
        }

        // 2) genera scusa come prima (se la tua function esiste)
        try {
          await fetch('/.netlify/functions/post-checkout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sessionId })
          });
        } catch (e) {
          console.warn('post-checkout error', e);
        }

        document.getElementById('status').textContent = 'Tempo accreditato e scusa generata. Puoi chiudere questa pagina.';
        document.getElementById('status').className = 'ok';
      }

      run();
    </script>
  </body>
</html>
