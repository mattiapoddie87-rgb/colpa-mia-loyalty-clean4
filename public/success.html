<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Grazie per l’acquisto – COLPA MIA</title>
    <style>
      :root { color-scheme: dark; }
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        background:#0b0d12;
        color:#e9eef5;
        margin:0;
        display:flex;
        align-items:center;
        justify-content:center;
        min-height:100vh;
      }
      .card {
        background:#0f1623;
        border:1px solid #1f2636;
        border-radius:14px;
        padding:32px;
        max-width:480px;
        text-align:center;
        box-shadow:0 0 20px rgba(0,0,0,0.3);
      }
      h1 { margin-bottom:8px; }
      .muted { color:#aaa; font-size:14px; margin-bottom:16px; }
      .ok { color:#29d07b; font-weight:600; }
      .err { color:#ff6b6b; font-weight:600; }
      .spinner {
        width:28px; height:28px;
        border:3px solid #334;
        border-top-color:#29d07b;
        border-radius:50%;
        margin:16px auto;
        animation:spin 1s linear infinite;
      }
      @keyframes spin { to { transform:rotate(360deg); } }
      a.btn {
        display:inline-block;
        margin-top:24px;
        padding:12px 20px;
        border-radius:10px;
        background:linear-gradient(135deg,#6c7dff,#8a6dff);
        color:white;
        text-decoration:none;
        font-weight:600;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Grazie per l’acquisto</h1>
      <p class="muted">Stiamo generando la tua scusa personalizzata…</p>
      <div id="status" class="spinner"></div>
      <div id="msg" class="muted"></div>
      <a href="/wallet.html" class="btn" id="walletBtn" style="display:none;">Vai al Wallet</a>
    </div>

    <script>
      async function sendExcuse(email) {
        try {
          const res = await fetch('/.netlify/functions/session-email', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
          });
          const out = await res.json().catch(() => ({}));
          if (!res.ok || out.error) throw new Error(out.error || 'Errore invio scusa');
          return true;
        } catch (err) {
          console.error('Errore invio scusa:', err);
          return false;
        }
      }

      async function init() {
        const msg = document.getElementById('msg');
        const status = document.getElementById('status');
        const btn = document.getElementById('walletBtn');

        const params = new URLSearchParams(window.location.search);
        const email = params.get('email') || '';

        if (!email) {
          status.className = 'err';
          msg.textContent = 'Email non trovata. Non possiamo inviare la scusa.';
          return;
        }

        msg.textContent = 'Invio in corso per ' + email + '...';

        const ok = await sendExcuse(email);

        if (ok) {
          status.className = 'ok';
          status.textContent = '✔';
          msg.textContent = 'Scusa inviata con successo! Controlla la tua email.';
          btn.style.display = 'inline-block';
          setTimeout(() => { window.location.href = '/wallet.html?email=' + encodeURIComponent(email); }, 7000);
        } else {
          status.className = 'err';
          status.textContent = '✖';
          msg.textContent = 'Errore durante l’invio della scusa. Riprova più tardi.';
          btn.style.display = 'inline-block';
        }
      }

      init();
    </script>
  </body>
</html>
