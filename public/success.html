<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Grazie per l’acquisto – COLPA MIA</title>
    <style>
      :root { color-scheme: dark; }
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        background:#0b0d12;
        color:#e9eef5;
        margin:0;
        min-height:100vh;
        display:flex;
        align-items:center;
        justify-content:center;
      }
      .card {
        background:#0f1623;
        border:1px solid #1f2636;
        border-radius:14px;
        padding:32px;
        max-width:480px;
        text-align:center;
      }
      h1 { margin-bottom:8px; }
      .muted { color:#aaa; font-size:14px; margin-bottom:14px; }
      .ok { color:#29d07b; font-weight:600; }
      .err { color:#ff6b6b; font-weight:600; }
      .spinner {
        width:28px; height:28px;
        border:3px solid #334;
        border-top-color:#29d07b;
        border-radius:50%;
        margin:16px auto;
        animation:spin 1s linear infinite;
      }
      @keyframes spin { to { transform:rotate(360deg); } }
      a.btn {
        display:inline-block;
        margin-top:22px;
        padding:12px 20px;
        border-radius:10px;
        background:linear-gradient(135deg,#6c7dff,#8a6dff);
        color:white;
        text-decoration:none;
        font-weight:600;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Grazie per l’acquisto</h1>
      <p class="muted">Stiamo inviando la scusa che hai generato.</p>
      <div id="status" class="spinner"></div>
      <div id="msg" class="muted"></div>
      <a href="/wallet.html" id="walletBtn" class="btn" style="display:none;">Vai al wallet</a>
    </div>

    <script>
      async function sendFromSession(sessionId) {
        const res = await fetch('/.netlify/functions/session-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ session_id: sessionId })
        });
        const out = await res.json().catch(()=> ({}));
        if (!res.ok || out.error) {
          throw new Error(out.error || ('HTTP ' + res.status));
        }
        // se la function ti restituisce l'email, usala per il redirect
        return out.email || null;
      }

      (async function init() {
        const p = new URLSearchParams(location.search);
        const sessionId = p.get('session_id');  // questo è quello che manda Stripe
        const status = document.getElementById('status');
        const msg = document.getElementById('msg');
        const btn = document.getElementById('walletBtn');

        if (!sessionId) {
          status.className = 'err';
          status.textContent = '✖';
          msg.textContent = 'Sessione non trovata. Non possiamo inviare la scusa.';
          btn.style.display = 'inline-block';
          return;
        }

        msg.textContent = 'Sessione trovata. Invio in corso…';

        try {
          const email = await sendFromSession(sessionId);
          status.className = 'ok';
          status.textContent = '✔';
          msg.textContent = email
            ? 'Scusa inviata a ' + email + '.'
            : 'Scusa inviata.';

          btn.style.display = 'inline-block';

          // redirect automatico
          setTimeout(() => {
            const to = email ? '/wallet.html?email=' + encodeURIComponent(email) : '/wallet.html';
            location.href = to;
          }, 6000);
        } catch (err) {
          console.error(err);
          status.className = 'err';
          status.textContent = '✖';
          msg.textContent = 'Non siamo riusciti a inviare la scusa: ' + err.message;
          btn.style.display = 'inline-block';
        }
      })();
    </script>
  </body>
</html>
