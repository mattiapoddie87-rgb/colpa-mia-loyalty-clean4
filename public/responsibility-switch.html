<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Responsibility Switch — Richiesta</title>
  <meta name="theme-color" content="#0b0f16"/>
  <style>
    :root{--bg:#0b0f16;--panel:#101724;--line:#1f2b46;--muted:#a9b4c6;--brand:#37c9ff;--brand2:#8a6dff;color-scheme:dark}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:#e9eef5;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{max-width:940px;margin:0 auto;padding:24px}
    .card{background:#101724;border:1px solid var(--line);border-radius:16px;padding:16px;margin:12px 0}
    h1{margin:0 0 8px}.muted{color:var(--muted)}
    label{display:block;margin:10px 0 6px;color:#cfd8ea}
    input,select,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid #273251;background:#0c101b;color:#e9eef5}
    textarea{min-height:120px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap}.row>*{flex:1 1 260px}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:12px}
    .btn{padding:12px 16px;border-radius:12px;border:0;background:#1b2a46;color:#fff;text-decoration:none;cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,var(--brand),var(--brand2));color:#061018;font-weight:800}
    .note{font-size:.9rem;color:#9fb0c9}.ok{color:#28d381}.err{color:#ff6b6b}
    .linkbox{display:flex;gap:8px;align-items:center}
    .linkbox input{flex:1}
    a{color:#9bd0ff;text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Responsibility Switch — Richiedi il link</h1>
    <p class="muted">Il sistema genera un link personale, lo salva e te lo invia via email. Condividilo con il destinatario: ogni sua scelta viene tracciata e ti arriva una notifica.</p>

    <div class="card">
      <div class="row">
        <div>
          <label>Email per la conferma</label>
          <input id="email" type="email" placeholder="tu@esempio.it" autocomplete="email" required>
        </div>
        <div>
          <label>Contesto</label>
          <select id="context">
            <option>CENA</option><option>APERITIVO</option><option>EVENTO</option><option>LAVORO</option>
            <option>PARTITA A CALCETTO</option><option>FAMIGLIA</option><option>SALUTE</option>
            <option>APPUNTAMENTO/CONSEGNA</option><option>ESAME/LEZIONE</option>
          </select>
        </div>
      </div>

      <label>Note/brief (opz.)</label>
      <textarea id="brief" placeholder="Es. dammi tre opzioni: sposto, call 10', voucher."></textarea>

      <div class="row">
        <div>
          <label>Scadenza link (opz.)</label>
          <select id="expires">
            <option value="">Nessuna</option><option>24 ore</option><option>3 giorni</option><option>7 giorni</option>
          </select>
        </div>
        <div>
          <label>Prova di consegna</label>
          <select id="pod"><option>Sì</option><option>No</option></select>
        </div>
      </div>

      <label class="note" style="display:flex;gap:8px;align-items:center;margin-top:12px">
        <input id="consent" type="checkbox" style="width:auto"> 
        Confermo la <a href="/manleva-switch.html" target="_blank" rel="noopener">manleva del Responsibility Switch</a>.
      </label>

      <div class="actions">
        <button class="btn primary" id="send">Genera link</button>
        <a class="btn" href="/#catalogo">Torna al catalogo</a>
        <span id="msg" class="note"></span>
      </div>

      <div id="out" class="card" style="display:none;margin-top:12px">
        <div class="linkbox">
          <input id="share" readonly>
          <button class="btn" id="copy">Copia</button>
        </div>
        <small class="note">Questo è il link per il destinatario. Ti è stato inviato anche via email.</small>
      </div>
    </div>
  </div>

  <script>
    const $ = s=>document.querySelector(s);
    $('#send').onclick = async ()=>{
      $('#msg').textContent=''; $('#out').style.display='none';
      const email   = $('#email').value.trim();
      const context = $('#context').value;
      const brief   = $('#brief').value.trim();
      const expires = $('#expires').value;
      const pod     = $('#pod').value;
      const ok      = $('#consent').checked;
      if(!email){ $('#msg').textContent='Inserisci una email.'; $('#msg').className='note err'; return; }
      if(!ok){ $('#msg').textContent='Devi accettare la manleva.'; $('#msg').className='note err'; return; }
      $('#send').disabled=true;
      try{
        const r = await fetch('/.netlify/functions/rs-request', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ email, context, brief, expires, pod })
        });
        const data = await r.json();
        if(!r.ok) throw new Error(data.error||'request_failed');
        $('#share').value = data.link;
        $('#out').style.display='block';
        $('#msg').textContent='Link generato ✔'; $('#msg').className='note ok';
      }catch(e){
        $('#msg').textContent='Errore: '+e.message; $('#msg').className='note err';
      }finally{ $('#send').disabled=false; }
    };
    $('#copy').onclick = async ()=>{ await navigator.clipboard.writeText($('#share').value); };
  </script>
</body>
</html>
