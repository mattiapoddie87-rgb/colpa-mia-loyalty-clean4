<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Responsibility Switch — Link</title>
  <meta name="theme-color" content="#0b0f16"/>
  <style>
    :root{--bg:#0b0f16;--panel:#101724;--line:#1f2b46;--muted:#a9b4c6;color-scheme:dark}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:#e9eef5;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{max-width:900px;margin:0 auto;padding:24px}
    .card{background:#101724;border:1px solid var(--line);border-radius:16px;padding:16px;margin:12px 0}
    .grid{display:grid;gap:10px}
    .btn{display:inline-block;padding:10px 14px;border-radius:12px;border:0;background:#3b82f6;color:#061018;text-decoration:none;font-weight:800}
    .muted{color:var(--muted)} .row{display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Responsibility Switch</h1>
    <div id="status" class="muted">Caricamento…</div>

    <div id="view" class="card" style="display:none">
      <p id="ctx" class="muted"></p>
      <div id="opts" class="grid"></div>
      <div class="row">
        <a id="btn-back" class="btn" href="/">Torna al catalogo</a>
      </div>
    </div>

    <div id="err" class="card" style="display:none">
      <p>Link non valido o scaduto.</p>
      <a class="btn" href="/">Torna al catalogo</a>
    </div>
  </div>

  <script>
    (async () => {
      const statusEl = document.getElementById('status');
      const viewEl   = document.getElementById('view');
      const errEl    = document.getElementById('err');
      const optsEl   = document.getElementById('opts');
      const ctxEl    = document.getElementById('ctx');

      // id = ultimo segmento del path /rs/:id
      const parts = location.pathname.replace(/\/+$/,'').split('/');
      const id = parts[parts.length - 1];
      if (!id) { statusEl.style.display='none'; errEl.style.display='block'; return; }

      try {
        // Recupera i dati del link
        const r = await fetch('/.netlify/functions/rs-get?id='+encodeURIComponent(id));
        if (!r.ok) throw new Error('not_ok');
        const data = await r.json();

        statusEl.style.display = 'none';
        viewEl.style.display = 'block';

        ctxEl.textContent = 'Contesto: ' + (data.context || '—');

        // Render opzioni
        (data.options || ['Riprogrammiamo','Richiamami','Voucher']).forEach((label, idx) => {
          const a = document.createElement('a');
          a.className = 'btn';
          a.href = '#';
          a.textContent = label;
          a.onclick = async (ev) => {
            ev.preventDefault();
            try {
              await fetch('/.netlify/functions/rs-choice', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ id, choiceIndex: idx, userAgent: navigator.userAgent })
              });
              alert('Scelta registrata: ' + label);
            } catch(e) {
              alert('Errore nel registrare la scelta');
            }
          };
          optsEl.appendChild(a);
        });

      } catch (e) {
        statusEl.style.display='none';
        errEl.style.display='block';
      }
    })();
  </script>
</body>
</html>
