<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Responsibility Switch</title>
  <meta name="theme-color" content="#0b0f16"/>
  <style>
    :root{--bg:#0b0f16;--panel:#101724;--line:#1f2b46;--muted:#a9b4c6;--btn:#3b82f6;--ok:#22c55e;--err:#ef4444;color-scheme:dark}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#e9eef5;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{max-width:920px;margin:24px auto;padding:0 16px}
    h1{margin:0 0 16px;font-size:clamp(22px,3.2vw,34px)}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px}
    .muted{color:var(--muted)}
    .row{display:flex;flex-direction:column;gap:10px;margin-top:6px}
    button{appearance:none;border:0;cursor:pointer}
    .btn{width:100%;text-align:left;padding:12px 14px;border-radius:12px;background:var(--btn);color:#061018;font-weight:700}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .ghost{background:#0f1a2b;color:#e9eef5;border:1px solid #1e3354}
    .msg{margin-top:12px;font-size:.95rem}
    .ok{color:var(--ok)} .err{color:var(--err)}
    .ctx{margin-bottom:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Responsibility Switch</h1>

    <div class="card">
      <div id="ctx" class="ctx muted">Contesto: <b id="ctxVal">—</b></div>

      <div class="row">
        <button id="b-reprogram" class="btn">Riprogrammiamo</button>
        <button id="b-callme"    class="btn">Richiamami</button>
        <button id="b-voucher"   class="btn">Voucher</button>
        <button id="b-back"      class="btn ghost">Torna al catalogo</button>
      </div>

      <div id="out" class="msg muted"></div>
      <div class="muted" style="margin-top:8px">Le scelte vengono registrate. Se necessario riceverai una conferma via email.</div>
    </div>
  </div>

  <script>
    // ---------------- helpers ----------------
    const $ = s => document.querySelector(s);
    const out = $('#out');
    const ctxEl = $('#ctxVal');

    function setMsg(text, cls='muted'){
      out.className = 'msg ' + cls;
      out.textContent = text;
    }

    function getTokenFromUrl(){
      // supporta /rs/<id|token> oppure ?token=/t=
      const path = location.pathname.replace(/\/+$/,'');
      const m = path.match(/\/rs\/([^\/]+)$/i);
      if (m && m[1]) return m[1];
      const q = new URLSearchParams(location.search);
      return q.get('token') || q.get('t') || '';
    }

    function getContextFromUrl(){
      const q = new URLSearchParams(location.search);
      return q.get('ctx') || q.get('context') || '';
    }

    async function hydrateContext(token, ctxFromUrl){
      if (ctxFromUrl){
        ctxEl.textContent = ctxFromUrl.toUpperCase();
        return;
      }
      if (!token) return;
      try{
        const r = await fetch('/.netlify/functions/rs-get?id=' + encodeURIComponent(token));
        if (r.ok){
          const d = await r.json();
          ctxEl.textContent = (d.context || '—').toUpperCase();
        }
      }catch{/* ignora */}
    }

    async function sendChoice(token, choice){
      if (!token){ setMsg('Link non valido o mancante (token assente).', 'err'); return; }
      const btns = ['#b-reprogram','#b-callme','#b-voucher'].map(s=>$(s));
      btns.forEach(b=>b.disabled = true);
      setMsg('Invio in corso…');

      try{
        const r = await fetch('/.netlify/functions/rs-choice', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ token, choice })
        });
        const bodyText = await r.text();
        let data = {};
        try { data = JSON.parse(bodyText); } catch {}
        if(!r.ok) throw new Error(data?.error || bodyText || ('HTTP '+r.status));

        if (data.next_action && data.next_action.url){
          if (data.next_action.type === 'open'){
            window.open(data.next_action.url,'_blank');
          } else {
            window.location.href = data.next_action.url;
          }
          return;
        }
        setMsg('Scelta registrata: ' + choice, 'ok');
      }catch(e){
        setMsg('Errore: ' + (e.message || 'server_error'), 'err');
      }finally{
        btns.forEach(b=>b.disabled = false);
      }
    }

    // ---------------- bootstrap ----------------
    (async function init(){
      const TOKEN = getTokenFromUrl();
      const CTX   = getContextFromUrl();

      if (!TOKEN){
        setMsg('Link non valido o mancante (token assente).', 'err');
      }
      await hydrateContext(TOKEN, CTX);

      $('#b-reprogram').onclick = ()=> sendChoice(TOKEN, 'reprogram');
      $('#b-callme').onclick    = ()=> sendChoice(TOKEN, 'callme');
      $('#b-voucher').onclick   = ()=> sendChoice(TOKEN, 'voucher');
      $('#b-back').onclick      = ()=> location.href = '/#catalogo';
    })();
  </script>
</body>
</html>
