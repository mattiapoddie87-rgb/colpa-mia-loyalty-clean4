<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Checkout COLPA MIA</title>
<meta name="theme-color" content="#0b0f16"/>
<style>
:root{--bg:#0b0f16;--panel:#101724;--muted:#a9b4c6;--line:#1a2540;--brand:#7c83ff}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;background:var(--bg);color:#e9eef5;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
.wrap{max-width:1100px;margin:20px auto;padding:0 16px}
a.btn,button.btn{padding:10px 14px;border-radius:12px;border:1px solid #2b3150;background:#0c0f17;color:#e6e6e6;text-decoration:none;cursor:pointer}
.btn.primary{background:var(--brand);border-color:var(--brand);color:#08101e;font-weight:800}
.panel{background:#0f1626;border:1px solid var(--line);border-radius:16px;padding:16px;margin-top:12px}
.title{font-weight:800}.price{font-weight:700}.sku{font-size:.9rem;color:#9fb0c9;margin:.25rem 0 .6rem}
.note{font-size:.9rem;color:#9fb0c9;margin-top:10px}.err{color:#ff6b6b}
.selected{outline:2px solid var(--brand)}
.row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
</style>
</head>
<body>
<div class="wrap">
  <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap">
    <h1>Checkout COLPA MIA</h1>
    <a class="btn" href="/#catalogo">↩ Torna al catalogo</a>
  </div>
  <p class="note">Inserisci l’email che userai in cassa. Puoi usare il codice promozionale <b>COLPAMIA10</b>.</p>

  <div class="panel">
    <div class="row" style="margin-top:6px">
      <div style="flex:1 1 260px">
        <label for="email">Email</label>
        <input id="email" type="email" placeholder="la-tua@email.com" autocomplete="email">
      </div>
      <div style="flex:1 1 220px">
        <label for="promo">Codice promo</label>
        <input id="promo" type="text" placeholder="COLPAMIA10" autocomplete="off">
      </div>
    </div>
    <p id="msg" class="note"></p>
  </div>

  <div id="chosen"></div>
</div>

<script>
const PRICE_DISPLAY = {
  SCUSA_BASE:'1,00 €', SCUSA_DELUXE:'4,50 €', TRAFFICO:'2,00 €', RIUNIONE:'2,00 €', CONNESSIONE:'2,00 €',
  COLPA_LIGHT:'9,90 €', COLPA_FULL:'19,90 €', COLPA_DELUXE:'39,90 €'
};
function qs(n){return new URLSearchParams(location.search).get(n)||'';}

(function renderPage(){
  const container=document.getElementById('chosen');
  const sku=qs('sku'); const title=qs('title')||sku; const ctx=qs('context')||'';
  const message=qs('message')||''; const tone=qs('tone')||'';
  if(!sku){container.innerHTML='<p class="note">Nessun prodotto selezionato.</p>'; return;}
  const price=PRICE_DISPLAY[sku]||'';
  container.innerHTML=`<div class="panel selected">
    <div class="title">${title}</div>
    <div class="price">${price}</div>
    <div class="sku">SKU: ${sku}${ctx?' • Contesto: '+ctx:''}${message?' • Messaggio allegato':''}</div>
    <button class="btn primary" id="buy" data-sku="${sku}" data-title="${title}" data-context="${ctx}" data-message="${encodeURIComponent(message)}" data-tone="${encodeURIComponent(tone)}">Procedi all’acquisto</button>
  </div>`;
})();

async function buy(payload){
  const email=document.getElementById('email').value.trim();
  const promo=(document.getElementById('promo').value||'').trim();
  const msgEl=document.getElementById('msg');
  if(!email){ msgEl.textContent='Inserisci l’email.'; msgEl.className='note err'; return; }
  msgEl.textContent='Creo la sessione di pagamento…'; msgEl.className='note';
  try{
    const r=await fetch('/.netlify/functions/create-checkout-session',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({...payload,email,promo})
    });
    const d=await r.json(); if(!r.ok) throw new Error(d.error||'Errore');
    location.href=d.url;
  }catch(e){
    msgEl.textContent='Errore: '+e.message; msgEl.className='note err';
  }
}

document.addEventListener('click',ev=>{
  if(ev.target && ev.target.id==='buy'){
    buy({
      sku:ev.target.dataset.sku,
      title:ev.target.dataset.title,
      context:ev.target.dataset.context,
      message:decodeURIComponent(ev.target.dataset.message||''),
      tone:decodeURIComponent(ev.target.dataset.tone||'')
    });
  }
});
</script>
</body>
</html>
